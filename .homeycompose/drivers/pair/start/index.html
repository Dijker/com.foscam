<link href="{{assets}}/css/styles.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>

<script type="text/javascript">
    Homey.setTitle(__('pair.title'));
</script>

<p data-i18n="pair.intro"></p>

<fieldset>
    <legend data-i18n="hostname"></legend>
    <input id="host" type="text" placeholder="192.168.1.1" value="" />
</fieldset>

<fieldset>
    <legend data-i18n="port"></legend>
    <input id="port" type="number" placeholder="88" value="" />
</fieldset>

<fieldset>
    <legend data-i18n="username"></legend>
    <input id="username" type="text" placeholder="admin" value="" />
</fieldset>

<fieldset>
    <legend data-i18n="password"></legend>
    <input id="password" type="password" value="" />
</fieldset>

<button id="connect" class="btn btn-green" data-i18n="pair.connect"></button>

<script type="text/javascript">

    $('input').focus(function () {
        $('#connect').html(__('pair.connect')).removeAttr('disabled');
        $(this).parent().removeClass('invalid');
    });

    $('#connect').on('click', function (e) {

        var $this = $(this);

        $this.html(__('loading-spinner')).prop('disabled', 'disabled');

        if (!validateForm()) {
            $this.html(__('pair.connect')).removeAttr('disabled');
            return false;
        }

        var settings = {
            host: $('#host').val(),
            port: Number($('#port').val()),
            username: $('#username').val(),
            password: $('#password').val()
        };

        Homey.emit('addDevice', settings, (err, result) => {
            if (err) {
                Homey.alert(err.message, 'error');
                $this.html(__('pair.connect')).removeAttr('disabled');
                return false;
            }

            settings.product_name = result.productName;
            settings.mac = result.mac.toString(16).match(/.{1,2}/g).reverse().join(':');
            settings.firmware_version = result.firmwareVer;
            settings.hardware_version = result.hardwareVer;

            var device = {
                name: result.devName,
                data: {
                    id: result.mac
                },
                settings: settings
            };

            Homey.createDevice(device, (err, result) => {
                if (err) {
                    Homey.alert(err, 'error');
                    $this.html(__('pair.connect')).removeAttr('disabled');
                } else {
                    $this.html(__('pair.connected')).prop('disabled', 'disabled');
                    Homey.alert(__('pair.successfull'), 'info');
                    Homey.done();
                }
            });
        });

    });

    function validateForm () {

        let error = false;

        $('.invalid').removeClass('invalid');

        if ($('#host').val().length === 0) {
            $('#host').parent().addClass('invalid');
            error = true;
        }

        if ($('#port').val().length === 0) {
            $('#port').parent().addClass('invalid');
            error = true;
        }

        if ($('#username').val().length === 0) {
            $('#username').parent().addClass('invalid');
            error = true;
        }

        if ($('#password').val().length === 0) {
            $('#password').parent().addClass('invalid');
            error = true;
        }

        if (error) {
            return false;
        }

        return true;
    }
</script>
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
        <script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>
        <link href="styles.css" rel="stylesheet" type="text/css" />
    </head>

    <body class="hy-nostyle">
        <div id="form">
            <h3 data-i18n="settings.title"></h3>
            <p data-i18n="settings.intro"></p>

            <div class="form-control">
                <label data-i18n="hostname"></label>
                <input id="host" type="text" placeholder="localhost" value="" />
            </div>

            <div class="form-control">
                <label data-i18n="port"></label>
                <input id="port" type="text" pattern="\d*" placeholder="587" value="" />
            </div>

            <div class="form-control">
                <label data-i18n="username"></label>
                <input id="username" type="text" value="" />
            </div>

            <div class="form-control">
                <label data-i18n="password"></label>
                <input id="password" type="password" value="" />
            </div>

            <div class="form-control">
                <label data-i18n="from"></label>
                <input id="from" type="text" placeholder="email@address.com" value="" />
            </div>

            <div class="form-control">
                <label data-i18n="recipient"></label>
                <input id="recipient" type="text" placeholder="email@address.com" value="" />
            </div>

            <div class="form-control">
                <label data-i18n="sendAs"></label>
                <select id="sendAs">
                    <option value="attachment" data-i18n="settings.attachment"></option>
                    <option value="inline" data-i18n="settings.inline"></option>
                </select>
            </div>

            <div class="form-control">
                <button id="save" class="button-primary" data-i18n="save"></button>
            </div>
        </div>

        <script type="text/javascript">

            function onHomeyReady (Homey) {

                $('link[href$="homey.css"]').remove();

                Homey.get('mail_host', function (err, mail_host) {
                    if (mail_host) { $('#host').val(mail_host); }
                });

                Homey.get('mail_port', function (err, mail_port) {
                    if (mail_port) { $('#port').val(mail_port); }
                });

                Homey.get('mail_username', function (err, mail_username) {
                    if (mail_username) { $('#username').val(mail_username); }
                });

                Homey.get('mail_password', function (err, mail_password) {
                    if (mail_password) { $('#password').val(mail_password); }
                });

                Homey.get('mail_from', function (err, mail_from) {
                    if (mail_from) { $('#from').val(mail_from); }
                });

                Homey.get('mail_recipient', function (err, mail_recipient) {
                    if (mail_recipient) { $('#recipient').val(mail_recipient); }
                });

                Homey.get('mail_send_as', function (err, mail_send_as) {
                    if (mail_send_as) { $('#sendAs').val(mail_send_as); }
                });

                Homey.ready();
            }

            $('#save').on('click', function (e) {

                if (!validateForm()) {
                    return false;
                }

                let settings = {
                    host: $('#host').val(),
                    port: Number($('#port').val()),
                    from: $('#from').val(),
                    username: $('#username').val(),
                    password: $('#password').val(),
                    recipient: $('#recipient').val(),
                    sendas: $('#sendAs').val()
                };

                Homey.api('PUT', '/verify_email_settings', settings, function (err, result) {
                    if (err) {
                        Homey.alert(err);
                    } else {

                        Homey.set('mail_host', settings.host);
                        Homey.set('mail_port', settings.port);
                        Homey.set('mail_username', settings.username);
                        Homey.set('mail_password', settings.password);
                        Homey.set('mail_from', settings.from);
                        Homey.set('mail_recipient', settings.recipient);
                        Homey.set('mail_send_as', settings.sendas);

                        Homey.alert(__('settings.saved'), 'info');
                    }
                });

            });

            function validateForm () {

                let error = false;
                let errMsg = Homey.__('error.insert_valid_value');

                $('.validation-error').remove();
                $('.invalid').removeClass('invalid');

                if ($('#host').val().length === 0) {
                    $('#host').addClass('invalid');
                    $('<p class="validation-error">' + errMsg + '</p>').insertAfter('#host');
                    error = true;
                }

                if ($('#port').val().length === 0) {
                    $('#port').addClass('invalid');
                    $('<p class="validation-error">' + errMsg + '</p>').insertAfter('#port');
                    error = true;
                }

                if ($('#from').val().length === 0) {
                    $('#from').addClass('invalid');
                    $('<p class="validation-error">' + errMsg + '</p>').insertAfter('#from');
                    error = true;
                }

                if ($('#recipient').val().length === 0) {
                    $('#recipient').addClass('invalid');
                    $('<p class="validation-error">' + errMsg + '</p>').insertAfter('#recipient');
                    error = true;
                }

                if (error) {
                    return false;
                }

                return true;
            }
        </script>
    </body>
</html>